
{% extends "base.html" %}

{% block title %}
    {{ playlist.name }}
{% endblock %}

{% block content %}

<div class="container text-center mt-2">
    <div class="info">
        <h2 class="text-white">Recomendaciones para {{ playlist.name }}</h2>
    </div>
    <div class="contenedor_principal">
        <div class="mitad izquierda">
            <h4 class="text-white">Recomendaciones</h4>
            <div class="overflow-auto p-2 lista_canciones lista_derecha">
                <ul>
                    {% for r in recs %}
                        <li style="margin: 0; padding: 0;">
                            <div class="iframe-container">
                                <iframe style="border-radius:12px; margin: 0; padding: 0; height: 85px;"
                                    onmouseover="actualizar({{ r|safe }})"
                                    data-src="https://open.spotify.com/embed/track/{{r.id}}?utm_source=generator&theme=0"
                                    width="100%" height="125" frameBorder="0" allowfullscreen=""
                                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                                    loading="lazy">
                                </iframe>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="separacion"></div>
        <div class="mitad derecha">
            <h4 class="text-white">Comparación de la canción con la playlist</h4>
            <div class="p-2 recs_derecha lista_canciones">
                <div class="feats-container text-center text-white">
                    <div class="bars-container">
                        <div class="bar-container acousticness">
                            <div class="bar-label">acousticness</div>
                            <div class="two-bar">
                                <div class="bar">
                                    <div class="bar-inner value-song"></div>
                                </div>
                                <div class="bar mt-1">
                                    <div class="bar-inner value-playlist"></div>
                                </div>
                            </div>
                            <div class="values-container">
                                <div class="value-song-label">-</div>
                                <div class="value-playlist-label mt-1"></div>
                            </div>
                        </div>
                        <div class="bar-container danceability">
                            <div class="bar-label">danceability</div>
                            <div class="two-bar">
                                <div class="bar">
                                    <div class="bar-inner value-song"></div>
                                </div>
                                <div class="bar mt-1">
                                    <div class="bar-inner value-playlist"></div>
                                </div>
                            </div>
                            <div class="values-container">
                                <div class="value-song-label">-</div>
                                <div class="value-playlist-label mt-1"></div>
                            </div>
                        </div>
                        <div class="bar-container energy">
                            <div class="bar-label">energy</div>
                            <div class="two-bar">
                                <div class="bar">
                                    <div class="bar-inner value-song"></div>
                                </div>
                                <div class="bar mt-1">
                                    <div class="bar-inner value-playlist"></div>
                                </div>
                            </div>
                            <div class="values-container">
                                <div class="value-song-label">-</div>
                                <div class="value-playlist-label mt-1"></div>
                            </div>
                        </div>
                        <div class="bar-container instrumentalness">
                            <div class="bar-label">instrumentalness</div>
                            <div class="two-bar">
                                <div class="bar">
                                    <div class="bar-inner value-song"></div>
                                </div>
                                <div class="bar mt-1">
                                    <div class="bar-inner value-playlist"></div>
                                </div>
                            </div>
                            <div class="values-container">
                                <div class="value-song-label">-</div>
                                <div class="value-playlist-label mt-1"></div>
                            </div>
                        </div>
                        <div class="bar-container tempo">
                            <div class="bar-label">tempo</div>
                            <div class="two-bar">
                                <div class="bar">
                                    <div class="bar-inner value-song"></div>
                                </div>
                                <div class="bar mt-1">
                                    <div class="bar-inner value-playlist"></div>
                                </div>
                            </div>
                            <div class="values-container">
                                <div class="value-song-label">-</div>
                                <div class="value-playlist-label mt-1"></div>
                            </div>
                        </div>
                        <div class="bar-container valence">
                            <div class="bar-label">valence</div>
                            <div class="two-bar">
                                <div class="bar">
                                    <div class="bar-inner value-song"></div>
                                </div>
                                <div class="bar mt-1">
                                    <div class="bar-inner value-playlist"></div>
                                </div>
                            </div>
                            <div class="values-container">
                                <div class="value-song-label">-</div>
                                <div class="value-playlist-label mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h4 class="text-white mt-2">Géneros en común de la canción con la playlist</h4>
            <div class="p-2 pl_derecha lista_canciones">
                <div class="genres-container text-center text-white">
                        <div class="genre none mt-2" id="genre1"></div>
                        <div class="genre none mt-2" id="genre2"></div>
                        <div class="genre none mt-2" id="genre3"></div>
                        <div class="genre none mt-2" id="genre4"></div>
                        <div class="genre none mt-2" id="genre5"></div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script>
<script>
    function actualizar(r) {
        const barsContainer = document.querySelector('.bars-container');
        const genresContainer = document.querySelector('.genres-container');
        const atributos = ['acousticness', 'danceability', 'energy', 'instrumentalness', 'tempo', 'valence'];
        
        atributos.forEach(atributo => {
            const valor = (r['valores'][atributo]*100).toFixed(2);
            const barra = document.querySelector(`.${atributo} .value-song`);
            const etiqueta = document.querySelector(`.${atributo} .value-song-label`);
            
            barra.style.width = valor + '%';
            etiqueta.textContent = valor;
        });

        const generos = r['genres'];
        if (generos.length === 0) {
            const genre = document.querySelector(`#genre1`);
            genre.textContent = 'No hay géneros en común con la playlist';
            genre.style.display = 'block';
            const genre2 = document.querySelector(`#genre2`);
            genre2.style.display = 'none';
            const genre3 = document.querySelector(`#genre3`);
            genre3.style.display = 'none';
            const genre4 = document.querySelector(`#genre4`);
            genre4.style.display = 'none';
            const genre5 = document.querySelector(`#genre5`);
            genre5.style.display = 'none';
        }
        else{
            generos.forEach((genero, i) => {
                const genre = document.querySelector(`#genre${i+1}`);
                genre.textContent = genero;
                genre.style.display = 'block';
            });
        }
    }

    // Función para actualizar las barras dinámicamente
    function actualizarBarras(valores) {
        const atributos = ['acousticness', 'danceability', 'energy', 'instrumentalness', 'tempo', 'valence'];
        
        atributos.forEach(atributo => {
            const valor = (valores[atributo]*100).toFixed(2);
            const barra = document.querySelector(`.${atributo} .value-playlist`);
            const etiqueta = document.querySelector(`.${atributo} .value-playlist-label`);
            
            barra.style.width = valor + '%';
            etiqueta.textContent = valor;
        });
    }

    // Valores pasados desde Django al template
    const valoresCancion = {{ mean_feat|safe }};

    // Actualizar las barras con los valores pasados
    actualizarBarras(valoresCancion);

    // Lazy loading de iframes
    const iframes = document.querySelectorAll('iframe[data-src]');

    const iframeObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const iframe = entry.target;
                iframe.src = iframe.dataset.src;
                observer.unobserve(iframe);
            }
        });
    });

    iframes.forEach(iframe => {
        iframeObserver.observe(iframe);
    });
</script>

<!--<div class="container text-center mt-2">
    <div class="info">
        <h2 class="text-white">Recomendaciones para {{ playlist.name }}</h2>
    </div>
    <div class="contenedor_principal">
        <div class="mitad izquierda ">
            <h4 class="text-white">Recomendaciones</h4>
            <div class="overflow-auto p-2 lista_canciones lista_derecha">
                <ul>
                    {% for r in recs %}
                        <li style="margin: 0; padding: 0;">
                            <div class="iframe-container">
                                <iframe style="border-radius:12px; margin: 0; padding: 0; height: 85px;"
                                    onmouseover="actualizar({{ r|safe }})"
                                    data-src="https://open.spotify.com/embed/track/{{r.id}}?utm_source=generator&theme=0"
                                    width="100%" height="125" frameBorder="0" allowfullscreen=""
                                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                                    loading="lazy">
                                </iframe>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    function actualizar(r) {
        const atributos = ['acousticness', 'danceability', 'energy', 'instrumentalness', 'tempo', 'valence'];
        
        atributos.forEach(atributo => {
            const valor = (r['valores'][atributo]*100).toFixed(2);
            const barra = document.querySelector(`.${atributo} .value-song`);
            const etiqueta = document.querySelector(`.${atributo} .value-song-label`);
            
            barra.style.width = valor + '%';
            etiqueta.textContent = valor;
        });

        const generos = r['genres'];
        if (generos.length === 0) {
            const genre = document.querySelector(`#genre1`);
            genre.textContent = 'No hay géneros en común con la playlist';
            genre.style.display = 'block';
        } else {
            generos.forEach((genero, i) => {
                const genre = document.querySelector(`#genre${i+1}`);
                genre.textContent = genero;
                genre.style.display = 'block';
            });
        }
    }

    // Lazy loading de iframes
    const iframes = document.querySelectorAll('iframe[data-src]');

    const iframeObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const iframe = entry.target;
                iframe.src = iframe.dataset.src;
                observer.unobserve(iframe);
            }
        });
    });

    iframes.forEach(iframe => {
        iframeObserver.observe(iframe);
    });
</script>-->
{% endblock %}

